<script type="module">
import {WebXRButton} from './js/util/webxr-button.js';
import {Scene} from './js/render/scenes/scene.js';
import {Renderer, createWebGLContext} from './js/render/core/renderer.js';
import {Node} from './js/render/core/node.js';
import {Gltf2Node} from './js/render/nodes/gltf2.js';

let xrButton;
let xrRefSpace;
let xrViewerSpace;
let xrHitTestSource;

let gl;
let renderer;
let scene = new Scene();
scene.clear = false;

let reticle;
let placedObject = null;
let objectPlaced = false;

let video;
let videoTexture;

const resetButton = document.createElement("button");
resetButton.innerText = "RESET";
resetButton.style.position = "absolute";
resetButton.style.bottom = "20px";
resetButton.style.left = "50%";
resetButton.style.transform = "translateX(-50%)";
resetButton.style.padding = "12px 20px";
resetButton.style.fontSize = "16px";
resetButton.style.display = "none";
document.body.appendChild(resetButton);
resetButton.onclick = resetPlacement;

initXR();

function initXR() {
  xrButton = new WebXRButton({
    onRequestSession,
    onEndSession,
    textEnterXRTitle: "START AR",
    textXRNotFoundTitle: "AR NOT FOUND",
    textExitXRTitle: "EXIT AR"
  });

  document.body.appendChild(xrButton.domElement);

  if (navigator.xr) {
    navigator.xr.isSessionSupported('immersive-ar')
      .then(supported => xrButton.enabled = supported);
  }
}

function onRequestSession() {
  return navigator.xr.requestSession('immersive-ar', {
    requiredFeatures: ['local', 'hit-test']
  }).then(session => {
    xrButton.setSession(session);
    onSessionStarted(session);
  });
}

function onSessionStarted(session) {

  session.addEventListener('end', () => xrButton.setSession(null));
  session.addEventListener('select', onSelect);

  gl = createWebGLContext({ xrCompatible: true });
  renderer = new Renderer(gl);
  scene.setRenderer(renderer);

  session.updateRenderState({
    baseLayer: new XRWebGLLayer(session, gl)
  });

  reticle = new Gltf2Node({ url: 'media/gltf/reticle/reticle.gltf' });
  reticle.visible = false;
  scene.addNode(reticle);

  session.requestReferenceSpace('viewer').then(space => {
    xrViewerSpace = space;
    session.requestHitTestSource({ space: xrViewerSpace })
      .then(source => xrHitTestSource = source);
  });

  session.requestReferenceSpace('local').then(space => {
    xrRefSpace = space;
    session.requestAnimationFrame(onXRFrame);
  });
}

function onEndSession(session) {
  if (xrHitTestSource) xrHitTestSource.cancel();
  session.end();
}

function createVideoObject(matrix) {

  // Use a flat GLTF plane instead of mesh.js
  placedObject = new Gltf2Node({
    url: 'media/gltf/quad/quad.gltf'  // ðŸ”¥ You must create this simple quad model
  });

  placedObject.matrix = matrix;

  video = document.createElement("video");
  video.src = "media/video.mp4";
  video.loop = true;
  video.muted = true;
  video.playsInline = true;
  video.crossOrigin = "anonymous";
  video.play();

  videoTexture = renderer.createTexture(video);

  // Wait until model loads, then replace texture
  placedObject.onLoaded = () => {
    placedObject.primitives.forEach(p => {
      p.material.baseColorTexture = videoTexture;
    });
  };

  scene.addNode(placedObject);

  objectPlaced = true;
  reticle.visible = false;
  resetButton.style.display = "block";
}

function resetPlacement() {
  if (placedObject) {
    scene.removeNode(placedObject);
    placedObject = null;
  }

  if (video) {
    video.pause();
    video = null;
  }

  objectPlaced = false;
  resetButton.style.display = "none";
}

function onSelect() {
  if (reticle.visible && !objectPlaced) {
    createVideoObject(reticle.matrix);
  }
}

function onXRFrame(t, frame) {

  const session = frame.session;
  const pose = frame.getViewerPose(xrRefSpace);

  if (!objectPlaced && xrHitTestSource && pose) {
    const hits = frame.getHitTestResults(xrHitTestSource);
    if (hits.length > 0) {
      const hitPose = hits[0].getPose(xrRefSpace);
      reticle.visible = true;
      reticle.matrix = hitPose.transform.matrix;
    } else {
      reticle.visible = false;
    }
  }

  if (video && video.readyState >= 2 && videoTexture) {
    videoTexture.setSource(video);
  }

  scene.startFrame();
  session.requestAnimationFrame(onXRFrame);
  scene.drawXRFrame(frame, pose);
  scene.endFrame();
}
</script>
