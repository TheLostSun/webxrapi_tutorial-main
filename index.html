<script type="module">
import {WebXRButton} from './js/util/webxr-button.js';
import {Scene} from './js/render/scenes/scene.js';
import {Renderer, createWebGLContext} from './js/render/core/renderer.js';
import {Node} from './js/render/core/node.js';
import {vec3} from './js/render/math/gl-matrix.js';

let xrButton = null;
let xrRefSpace = null;
let xrViewerSpace = null;
let xrHitTestSource = null;

let gl = null;
let renderer = null;
let scene = new Scene();
scene.enableStats(false);
scene.clear = false;

let reticle = new Node();
reticle.visible = false;
scene.addNode(reticle);

let placedObject = null;
let objectPlaced = false;

let video = null;
let videoTexture = null;

const resetButton = document.createElement("button");
resetButton.innerText = "RESET";
resetButton.style.position = "absolute";
resetButton.style.bottom = "20px";
resetButton.style.left = "50%";
resetButton.style.transform = "translateX(-50%)";
resetButton.style.padding = "12px 20px";
resetButton.style.fontSize = "16px";
resetButton.style.display = "none";
document.body.appendChild(resetButton);

resetButton.addEventListener("click", resetPlacement);

function initXR() {
  xrButton = new WebXRButton({
    onRequestSession: onRequestSession,
    onEndSession: onEndSession,
    textEnterXRTitle: "START AR",
    textXRNotFoundTitle: "AR NOT FOUND",
    textExitXRTitle: "EXIT AR",
  });

  document.querySelector('header').appendChild(xrButton.domElement);

  if (navigator.xr) {
    navigator.xr.isSessionSupported('immersive-ar')
      .then((supported) => xrButton.enabled = supported);
  }
}

function onRequestSession() {
  return navigator.xr.requestSession('immersive-ar', {
    requiredFeatures: ['local', 'hit-test']
  }).then((session) => {
    xrButton.setSession(session);
    onSessionStarted(session);
  });
}

function onSessionStarted(session) {
  session.addEventListener('end', onSessionEnded);
  session.addEventListener('select', onSelect);

  if (!gl) {
    gl = createWebGLContext({ xrCompatible: true });
    renderer = new Renderer(gl);
    scene.setRenderer(renderer);
  }

  session.updateRenderState({ baseLayer: new XRWebGLLayer(session, gl) });

  session.requestReferenceSpace('viewer').then((refSpace) => {
    xrViewerSpace = refSpace;
    session.requestHitTestSource({ space: xrViewerSpace }).then((source) => {
      xrHitTestSource = source;
    });
  });

  session.requestReferenceSpace('local').then((refSpace) => {
    xrRefSpace = refSpace;
    session.requestAnimationFrame(onXRFrame);
  });
}

function onEndSession(session) {
  if (xrHitTestSource) {
    xrHitTestSource.cancel();
    xrHitTestSource = null;
  }
  session.end();
}

function onSessionEnded() {
  xrButton.setSession(null);
}

function createVideoQuad(matrix) {
  placedObject = new Node();
  placedObject.matrix = matrix;

  const geometry = renderer.createPlanePrimitive(1, 0.6);

  video = document.createElement("video");
  video.src = "media/video.mp4"; // <-- replace with your video
  video.loop = true;
  video.muted = true;
  video.playsInline = true;
  video.play();

  videoTexture = renderer.createTexture(video);

  geometry.material.baseColorTexture = videoTexture;

  placedObject.addNode(geometry);
  scene.addNode(placedObject);

  objectPlaced = true;
  reticle.visible = false;
  resetButton.style.display = "block";
}

function resetPlacement() {
  if (placedObject) {
    scene.removeNode(placedObject);
    placedObject = null;
  }

  if (video) {
    video.pause();
    video = null;
  }

  objectPlaced = false;
  resetButton.style.display = "none";
}

function onSelect() {
  if (reticle.visible && !objectPlaced) {
    createVideoQuad(reticle.matrix);
  }
}

function onXRFrame(t, frame) {
  let session = frame.session;
  let pose = frame.getViewerPose(xrRefSpace);

  if (!objectPlaced) {
    reticle.visible = false;

    if (xrHitTestSource && pose) {
      let results = frame.getHitTestResults(xrHitTestSource);
      if (results.length > 0) {
        let hitPose = results[0].getPose(xrRefSpace);
        reticle.visible = true;
        reticle.matrix = hitPose.transform.matrix;
      }
    }
  }

  scene.startFrame();
  session.requestAnimationFrame(onXRFrame);
  scene.drawXRFrame(frame, pose);
  scene.endFrame();
}

initXR();
</script>
